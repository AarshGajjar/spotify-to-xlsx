<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotify to Excel Exporter</title>
    <!-- SheetJS Library for Excel Export -->
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <style>
        body { font-family: sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; background-color: #f0f2f5; margin: 0; }
        .container { background: white; padding: 2rem; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); text-align: center; max-width: 400px; width: 100%; }
        h2 { color: #1DB954; }
        input { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
        button { background-color: #1DB954; color: white; border: none; padding: 10px 20px; border-radius: 25px; cursor: pointer; font-weight: bold; width: 100%; font-size: 1rem; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        .hidden { display: none; }
        #status { margin-top: 10px; font-size: 0.9rem; color: #666; }
    </style>
</head>
<body>

<div class="container">
    <!-- Login View -->
    <div id="login-view">
        <h2>Spotify Exporter</h2>
        <p>Login to export a playlist to Excel.</p>
        <button onclick="login()">Login with Spotify</button>
    </div>

    <!-- App View -->
    <div id="app-view" class="hidden">
        <h2>Export Playlist</h2>
        <p>Paste your playlist link below:</p>
        <input type="text" id="playlist-link" placeholder="https://open.spotify.com/playlist/..." />
        <button id="export-btn" onclick="exportPlaylist()">Download Excel</button>
        <p id="status"></p>
    </div>
</div>

<script>
    // --- CONFIGURATION ---
    const CLIENT_ID = 'f2d3386470e548529f65ff2ff634d8c7'; 
    
    const REDIRECT_URI = window.location.href.split('#')[0]; 

    let accessToken = null;

    // 1. Check if we just returned from Spotify login
    window.onload = function() {
        const hash = window.location.hash;
        if (hash && hash.includes('access_token')) {
            const token = hash.substring(1).split('&').find(elem => elem.startsWith('access_token')).split('=')[1];
            accessToken = token;
            // Clear the token from the URL bar for security
            window.location.hash = '';
            showApp();
        } else {
            showLogin();
        }
    }

    function showLogin() {
        document.getElementById('login-view').classList.remove('hidden');
        document.getElementById('app-view').classList.add('hidden');
    }

    function showApp() {
        document.getElementById('login-view').classList.add('hidden');
        document.getElementById('app-view').classList.remove('hidden');
    }

    // 2. Redirect to Spotify for Login
    function login() {
        const scope = 'playlist-read-private';
        const authURL = `https://accounts.spotify.com/authorize?client_id=${CLIENT_ID}&response_type=token&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&scope=${encodeURIComponent(scope)}`;
        window.location.href = authURL;
    }

    // 3. Fetch and Export Logic
    async function exportPlaylist() {
        const linkInput = document.getElementById('playlist-link').value;
        const status = document.getElementById('status');
        const btn = document.getElementById('export-btn');

        if (!linkInput) {
            status.textContent = "Please paste a link first.";
            status.style.color = "red";
            return;
        }

        // Extract Playlist ID
        let playlistId;
        try {
            playlistId = linkInput.split("playlist/")[-1].split("?")[0];
        } catch (e) {
            status.textContent = "Invalid Link.";
            status.style.color = "red";
            return;
        }

        btn.disabled = true;
        status.textContent = "Fetching tracks... please wait.";
        status.style.color = "#1DB954";

        try {
            const tracks = [];
            let url = `https://api.spotify.com/v1/playlists/${playlistId}/tracks?limit=50`;

            // Loop through all pages
            while (url) {
                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                
                if (!response.ok) throw new Error("Failed to fetch data. Token might be expired.");

                const data = await response.json();
                
                data.items.forEach(item => {
                    if (item.track) {
                        tracks.push({
                            "Artist Name(s)": item.track.artists.map(a => a.name).join(", "),
                            "Track Name": item.track.name
                        });
                    }
                });

                url = data.next; // Spotify provides the next URL in the response
            }

            // 4. Generate Excel
            const ws = XLSX.utils.json_to_sheet(tracks);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Playlist");
            XLSX.writeFile(wb, "Spotify_Playlist.xlsx");
            
            status.textContent = "Download started!";
        } catch (error) {
            console.error(error);
            status.textContent = "Error: " + error.message;
            status.style.color = "red";
        } finally {
            btn.disabled = false;
        }
    }
</script>

</body>
</html>